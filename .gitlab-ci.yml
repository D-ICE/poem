include:
  - project: 'common/ci-utils'
    file:
      - '/templates/.add-ssh-key.yml'
      - '/templates/.add-aws-key.yml'

.scripts:
  deps:
    - apt update
    - apt remove cmake
    - apt install -y git build-essential
    - pip install cmake

  cmake:
    - mkdir build && cd build
    - cmake ..
      -DCMAKE_BUILD_TYPE=Release
      -DPOEM_BUILD_TESTS=$ENABLE_TEST
      -DPOEM_BUILD_TOOLS=ON
      -DPOEM_ALLOW_DIRTY=OFF
      -DPOEM_BUILD_PYTHON=ON


test:
  #  except:
  #    - tags  # don't run the tests on tags
  image: "python:$PYTHON_VERSION-bullseye"

  variables:
    PYTHON_VERSION: "3.10"
    ENABLE_TEST: "ON"

  before_script:
    - !reference [.add-ssh-key, before_script]
    - !reference [.scripts, deps]
  script:
    - !reference [.scripts, cmake]
    - make poem_tests -j6
    - cd bin/tests
    - ./poem_tests


.build:
  only:
    - tags
  image: "python:$PYTHON_VERSION-bullseye"

  before_script:
    - !reference [.add-ssh-key, before_script]
    - !reference [.scripts, deps]

  script:
    - !reference [.scripts, cmake]
    - make pypoem -j6


python312:
  variables:
    PYTHON_VERSION: "3.12"
    ENABLE_TEST: "OFF"
  extends:
    - .build





#.build:
#
#  image: "python:$PYTHON_VERSION-bullseye"
#
#  variables:
#    PYTHON_VERSION:
#
#  before_script:
#    - !reference [ .add-ssh-key, before_script ]
#    - !reference [ .script, deps]
##    - !reference [ .add-aws-key, before_script ]
#    - apt update
#    - apt remove cmake
#    - apt install -y python3 python3-pip git
#    - pip install cmake
#
#  script:


#build-testing:
#
#  image: ubuntu:20.04
#
#  before_script:
#    - !reference [ .build, before_script ]
#
#  script:
#    - !reference [ .build, script ]
#    - make poem_tests -j6
#    - cd bin/tests
#    - ./poem_tests
